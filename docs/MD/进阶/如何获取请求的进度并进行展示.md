---
title: å¦‚ä½•èŽ·å–è¯·æ±‚çš„è¿›åº¦å¹¶è¿›è¡Œå±•ç¤ºï¼ŸðŸ”¥
date: 2024-8-10
categories:
  - è¿›é˜¶
tags:
  - HTTP
---

[åŽŸæ–‡](https://juejin.cn/post/7397323474274041856)

### **xhrï¼ˆXMLHttpRequestï¼‰ç›‘å¬å“åº”è¿›åº¦**
xhr çš„å“åº”è¿›åº¦æ˜¯æ¯”è¾ƒå¥½èŽ·å–çš„ï¼Œå› ä¸º js å®˜æ–¹æä¾›äº†ä¸€ä¸ªç›‘å¬å‡½æ•° progress æ¥å¯¹å“åº”è¿›åº¦è¿›è¡Œç›‘å¬ã€‚è¿™ä¸ªæ–¹æ³•æŽ¥æ”¶ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸­æœ‰ä¸¤ä¸ªå±žæ€§å¾ˆé‡è¦ï¼š
* total: æ€»å“åº”æ•°æ®çš„é•¿åº¦
* loaded: å·²åŠ è½½çš„å“åº”æ•°æ®çš„é•¿åº¦
```js
const xhr = new XMLHttpRequest();
const url = "xxx";
xhr.open('GET', url, true);
xhr.onreadystatechange - function () {
    if(xhr.readyState === 4 && xhr.status === 200){
        const data = xhr.responseText;
    }
}
xhr.addEventListener('progress', e => {
    const { loaded, total} = e;
    //è¯·æ±‚è¿›åº¦
    const precent = loaded / total * 100;
})
xhr.send();
```

### **Fetch ç›‘å¬å“åº”è¿›åº¦**
Fetch æ²¡æœ‰æä¾›ç›‘å¬å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±èŽ·å– loaded å’Œ total:
* ä»Žè¯·æ±‚å¤´èŽ·å–åˆ° content-length æ€»é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯ total
* å†ç”¨æ•°æ®æµçš„ api body.getReader åŽ»è¯»å–å“åº”ä½“å·²åŠ è½½çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯ loaded
```js
const request = () => {
    fetch(url).then(async res => {
        if(!res || res.body) return;
        // ä»Žè¯·æ±‚å¤´èŽ·å– content-length çš„æ€»é•¿åº¦
        const contentLenght = res.headers.get('content-length');
        const total = contentLenght ? parseInt(contentLength, 10) : 0;
        let loaded = 0;
        // è¯»å–æ•°æ®æµ
        const reader = res.body.geReader();
        while(true){
            const { done, value } = await reader.read();
            if(done){
                break;
            }
            loaded += value.length;
            // è¿›åº¦
            precent = loaded / total * 100;
        }
    })
}
```

### **xhr ç›‘å¬ä¸Šä¼ è¿›åº¦**
`fetch ç›®å‰è¿˜æ²¡æœ‰æ–¹æ³•ç›‘å¬ä¸Šä¼ è¿›åº¦`ï¼Œä½†æ˜¯ xhr å¯ä»¥ä½¿ç”¨ XMLHttRequest.upload è‡ªå¸¦çš„ç›‘å¬å‡½æ•° progress æ¥å®žçŽ°ï¼š
```js
xhr.upload.addEventListener('progress', e => {
    const { total, loaded} = e;
    const precent = loaded / total * 100;
})
```